<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
  var url = 'https://software.ecmwf.int/wiki';
  var api_url = url + '/rest/api/content';
  
  $(function() {
    /****************
    Page IDs of 'Documentation' page unless stated otherwise
    *******************/
    var swdoc = {};
    swdoc[35753255] = {'name':'BUFRDC'};
    swdoc[40804824] = {'name':'ECaccess','alt':'User guide'};
    swdoc[45748339] = {'name':'ecCodes'};
    swdoc[13207146] = {'name':'ecFlow'};
    swdoc[41648799] = {'name':'ECMWF Web API','alt':'need to parse the content on this one....'};
    swdoc[22908294] = {'name':'EMOSLIB','alt':'Using EMOSLIB'};
    swdoc[7373225] = {'name':'GRIB-API'};
    swdoc[14157858] = {'name':'Magics','alt':'Using Magics'};
    swdoc[14157950] = {'name':'Metview'};
    
    //filter the help file to the selected space, if applicable
    pageId = getParameterByName('pageId');
    var swdocSelected = {};
    if(typeof pageId != 'undefined' && typeof swdoc[pageId] != 'undefined') {
      swdocSelected[pageId] = swdoc[pageId];
    } else {
      swdocSelected = swdoc;
    }

    $.each(swdocSelected, function(parentId,parent) {
      $.getJSON(api_url + '/search?cql=parent=' + parentId, function(data) {
        var headerHtml = '<h1>' + parent.name + ' Help</h1>';
        headerHtml += '<p class="alt">(from ' + (typeof parent.alt=='undefined' ? 'Documentation' : parent.alt) + ')</p>';
        headerHtml += '<p class="nav">| <a href="' + window.location.href + '">home</a> | print | search online documentation |<p>';
        $('#helpHeader').empty().append(headerHtml);  //only shows last if array;  TODO: default to s/w/ space if no ID and remove each loop

        var topicsHtml = '<h2>Topics</h2>';
        $.each(data.results, function(key,child) { //console.log(child);
          topicsHtml += '<p class="topic" onclick="loadTopic(' + child.id + ');">' + child.title + '</p>'; //<a href="' + url + child._links.webui + '"></a>
        });
        $('#helpContent').empty().append(topicsHtml);  //only shows last if array; TODO: default to s/w/ space if no ID and remove each loop
      });     
    });
  });
  
  function loadTopic(childId) {
    $.getJSON(api_url + '/' + childId + '?expand=body.view', function(data) {
      var topicHtml = data.body.view.value;
      topicHtml += 'Was this helpful? Yes | No';  //TODO
      $('#helpContent').empty().append(topicHtml);

      //add event listener to any links
      $('#helpContent a').click(function(event) {
        if(isWikiLink(this.pathname)) {
          var arrUrl = [];
          arrUrl = this.pathname.split('/'); // /wiki/display/ECAC/Security+authentication
          console.log(arrUrl);
          $.getJSON(api_url + '?title' + arrUrl[2] + '&spaceKey=' + arrUrl[3], function(data) {
            loadTopic(data.results[0].id);
          });
        } else {
          if(confirm("This is a link to a site outside this help system. Do you wish to proceed (opens in new window)?")) {
            window.open(this.pathname);
          }
          event.preventDefault();
        }
      });
    });
  }
              
  function isWikiLink(href) {
    return (href.substring(0,13)=='/wiki/display' ? true : false );
  }
  
  function getParameterByName(name) {
      var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
      return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
  }

</script>
<style>
  h1 { margin-bottom: 0; }
  .alt { margin-top: 0; }
  .nav { color: lightgrey; }
  .topic { margin-top: 8px; margin-bottom: 8px; }
</style>
</head>
<body>
  <div id="helpHeader"></div>
  <div id="helpContent"></div>
</body>
</html>
