<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
  /****************
  Page IDs of 'Documentation' page unless stated otherwise
  *******************/
  var swdoc = {};
  swdoc[17531265] = {'name':'User Documentation'}; //default
  swdoc[35753255] = {'name':'BUFRDC'};
  swdoc[40804824] = {'name':'ECaccess','alt':'User guide'};
  swdoc[45748339] = {'name':'ecCodes'};
  swdoc[13207146] = {'name':'ecFlow'};
  swdoc[41648799] = {'name':'ECMWF Web API','alt':'need to parse the content on this one....'};
  swdoc[22908294] = {'name':'EMOSLIB','alt':'Using EMOSLIB'};
  swdoc[7373225] = {'name':'GRIB-API'};
  swdoc[14157858] = {'name':'Magics','alt':'Using Magics'};
  swdoc[14157950] = {'name':'Metview'};

  pageId = (typeof pageId != 'undefined' && typeof swdoc[pageId] != 'undefined') ? 17531265 : getParameterByName('pageId'); //default - User Doc space  
  
  var url = 'https://software.ecmwf.int/wiki';
  var apiUrl = url + '/rest/api/content';
  
  var clickHistory = [];
  var clickNumber = -1; 
  
  $(function() {
    var headerHtml = '<h1>' + parent.name + ' Help</h1>';
    headerHtml += '<p class="alt">(from ' + (typeof parent.alt=='undefined' ? 'Documentation' : parent.alt) + ')</p>';
    headerHtml += '<p class="nav">| <span onclick="goHistory(-1);"><<<</span> | <span onclick="goHistory(1);">>>></span> | <span onclick="loadTopics(' + pageId + ');">home</span> | print | search online documentation |<p>';
    $('#helpHeader').empty().append(headerHtml);  //only shows last if array;  TODO: default to s/w/ space if no ID and remove each loop
  
    loadTopics(pageId);
  });
  
  function loadTopics(parentId,byHistory) {
    
    if(!byHistory) writeToHistory(parentId,'parent'); //this should only run if not called from back/fwd
 
    $.getJSON(apiUrl + '/search?cql=parent=' + parentId, function(data) {
      var topicsHtml = '<h2>Topics</h2>';
      $.each(data.results, function(key,child) { //console.log(child);
        topicsHtml += '<p class="topic" onclick="loadTopic(' + child.id + ');">' + child.title + '</p>'; //<a href="' + url + child._links.webui + '"></a>
      });
      $('#helpContent').empty().append(topicsHtml);
    });     
  }
  
  function loadTopic(childId,byHistory) {
    
    if(!byHistory) writeToHistory(childId,'child'); //this should only run if not called from back/fwd
    
    $.getJSON(apiUrl + '/' + childId + '?expand=body.view', function(data) {
      var topicHtml = data.body.view.value;  //TODO: rewrite image links as absolute (maybe links too, and then change later test that looks for wikilinks)
      topicHtml += 'Was this helpful? Yes | No';  //TODO
      $('#helpContent').empty().append(topicHtml);

      //add event listener to any links
      $('#helpContent a').click(function(event) {
        event.preventDefault();  //first, stop the link working
        
        var href = event.currentTarget.attributes['href'].nodeValue; //the href of the clicked link
        
        //then deal with what type of link it is
        if(isWikiLink(href)) {
          var arrUrl = [];
          arrUrl = href.split('/');
          $.getJSON(apiUrl + '?title=' + arrUrl[4] + '&spaceKey=' + arrUrl[3], function(data) {
            loadTopic(data.results[0].id);
          });
        } else if(isBookmark(href)) {
          location.hash = href;
        } else {
          if(confirm("This is a link to a site outside this help system. Do you wish to proceed (opens in new window)?")) {
            window.open(href);
          }
        }
      });
    });
  }
              
  function writeToHistory(id,type) {
    clickNumber++;
    //adds new history item to array, removing anything beyond it
    clickHistory.splice(clickNumber, clickHistory.length - clickNumber, {'pageId':id, 'type':type}); 
  }
  
  function goHistory(clickIncrement) { 
    if(typeof clickHistory[clickNumber+clickIncrement]=='undefined') { //there's no back or fwd possible
      return false; console.log('step ' + clickNumber + ' doesn\'t exist');
    }
                                      
    clickNumber += clickIncrement;
    if(clickHistory[clickNumber].type=='parent') {
      loadTopics(clickHistory[clickNumber].pageId,true);  //list of topics
    } else {  //child
      loadTopic(clickHistory[clickNumber].pageId,true);  //topic content
    }
  }
  
  function isBookmark(href) {
    return (href.substring(0,1)=='#' ? true : false);
  }
  
  function isWikiLink(href) {
    return (href.substring(0,13)=='/wiki/display' || href.substring(26,39)=='/wiki/display' ? true : false);
  }
  
  function getParameterByName(name) {
      var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
      return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
  }

</script>
<style>
  h1 { margin-bottom: 0; }
  .alt { margin-top: 0; }
  .nav { color: lightgrey; }
  .topic { margin-top: 8px; margin-bottom: 8px; }
</style>
</head>
<body>
  <div id="helpHeader"></div>
  <div id="helpContent"></div>
</body>
</html>
